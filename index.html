<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English to Khmer Translator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better readability */
        @import url('https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Sora', sans-serif; /* Changed font to Sora */
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* Add some padding around the content */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* Ensure the main container is responsive */
        .container {
            width: 100%;
            max-width: 600px; /* Max width for desktop */
        }
        /* Custom spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">English to Khmer Translator</h1>

        <!-- English Input Section -->
        <div class="mb-5">
            <label for="englishInput" class="block text-gray-700 text-sm font-medium mb-2">Enter English Text:</label>
            <textarea
                id="englishInput"
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ease-in-out resize-y min-h-[120px] max-h-[300px]"
                placeholder="Type your English text here..."
            ></textarea>
        </div>

        <!-- Translate Button -->
        <div class="flex justify-center mb-5">
            <button
                id="translateButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
                Translate
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex justify-center items-center mb-5">
            <div class="animate-spin-custom rounded-full h-8 w-8 border-4 border-t-4 border-blue-500 border-opacity-25 border-t-blue-500"></div>
            <span class="ml-3 text-blue-600 font-medium">Translating...</span>
        </div>

        <!-- Khmer Output Section -->
        <div>
            <label for="khmerOutput" class="block text-gray-700 text-sm font-medium mb-2">Khmer Translation:</label>
            <textarea
                id="khmerOutput"
                class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 focus:outline-none resize-y min-h-[120px] max-h-[300px]"
                placeholder="Translation will appear here..."
                readonly
            ></textarea>
        </div>

        <!-- Message Box for errors/info -->
        <div id="messageBox" class="hidden mt-4 p-3 rounded-lg text-sm text-red-700 bg-red-100 border border-red-200">
            <!-- Error messages will be displayed here -->
        </div>
    </div>

    <script type="module">
        // Get references to HTML elements
        const englishInput = document.getElementById('englishInput');
        const translateButton = document.getElementById('translateButton');
        const khmerOutput = document.getElementById('khmerOutput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        // Define Firebase configuration and app ID (provided by the environment)
        // These are global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Function to display messages in the message box
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg text-sm ${type === 'error' ? 'text-red-700 bg-red-100 border border-red-200' : 'text-green-700 bg-green-100 border border-green-200'}`;
            messageBox.classList.remove('hidden');
        }

        // Function to hide the message box
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        // Event listener for the translate button
        translateButton.addEventListener('click', async () => {
            const englishText = englishInput.value.trim();

            // Clear previous output and messages
            khmerOutput.value = '';
            hideMessageBox();

            if (!englishText) {
                showMessage('Please enter some English text to translate.', 'error');
                return;
            }

            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            translateButton.disabled = true; // Disable button during translation

            try {
                // Construct the prompt for the Gemini API
                const prompt = `Translate the following English text to Khmer. Provide only the Khmer translation and nothing else:\n\n"${englishText}"`;

                // Prepare the payload for the Gemini API call
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                // API key is left empty as Canvas will provide it at runtime for gemini-2.0-flash
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                // Make the fetch call to the Gemini API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();

                // Check for valid response structure
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const translatedText = result.candidates[0].content.parts[0].text;
                    khmerOutput.value = translatedText;
                } else {
                    showMessage('Translation failed: No valid response from the AI.', 'error');
                }

            } catch (error) {
                console.error('Translation error:', error);
                showMessage(`Translation failed: ${error.message}. Please try again.`, 'error');
            } finally {
                // Hide loading indicator and re-enable button
                loadingIndicator.classList.add('hidden');
                translateButton.disabled = false;
            }
        });
    </script>
</body>
</html>
